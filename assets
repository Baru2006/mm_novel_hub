/* --- CSS Variables --- */
:root {
    --bg-dark-violet: #1b0f3a;
    --bg-midnight-blue: #2a175a;
    --primary-gold: #fde047;
    --light-gold: #fffbeb;
    --primary-purple: #a855f7;
    --text-light: #f3f4f6;
    --text-dark: #374151;
    --border-glow: rgba(253, 224, 71, 0.4);
    --font-primary: 'Poppins', 'Noto Sans Myanmar', sans-serif;
}

/* --- Base & Reset --- */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html {
    scroll-behavior: smooth;
}

body {
    font-family: var(--font-primary);
    background: linear-gradient(135deg, var(--bg-dark-violet), var(--bg-midnight-blue));
    color: var(--text-light);
    line-height: 1.6;
    overflow-x: hidden;
}

.container {
    width: 90%;
    max-width: 1200px;
    margin: 0 auto;
}

a {
    color: var(--primary-gold);
    text-decoration: none;
    transition: color 0.3s ease;
}

a:hover {
    color: var(--light-gold);
}

img {
    max-width: 100%;
    height: auto;
    display: block;
}

ul {
    list-style: none;
}

.section-title {
    text-align: center;
    font-size: 2rem;
    margin-bottom: 2rem;
    font-weight: 600;
    background: linear-gradient(90deg, var(--primary-gold), var(--primary-purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: fadeIn 1s ease-out;
}

/* --- Header & Navigation --- */
#main-header {
    position: sticky;
    top: 0;
    width: 100%;
    z-index: 1000;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

#main-header.scrolled {
    background-color: rgba(27, 15, 58, 0.8);
    backdrop-filter: blur(10px);
    box-shadow: 0 2px 20px var(--border-glow);
}

#main-header nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 70px;
}

.logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.logo h1 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-light);
}

.nav-links {
    display: flex;
    gap: 2rem;
}

.nav-links a {
    color: var(--text-light);
    font-weight: 500;
    position: relative;
    padding: 5px 0;
}

.nav-links a::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--primary-gold), var(--primary-purple));
    transition: width 0.3s ease;
}

.nav-links a:hover::after,
.nav-links a.active::after {
    width: 100%;
}

.dropdown {
    position: relative;
}

.dropdown-content {
    display: none;
    position: absolute;
    top: 120%;
    left: 0;
    background-color: var(--bg-midnight-blue);
    min-width: 160px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    border-radius: 8px;
    overflow: hidden;
}

.dropdown-content a {
    color: var(--text-light);
    padding: 12px 16px;
    display: block;
}
.dropdown-content a::after { display: none; } /* No underline for dropdown links */

.dropdown-content a:hover {
    background-color: var(--primary-purple);
}

.dropdown:hover .dropdown-content {
    display: block;
}

/* Hamburger Menu */
.hamburger {
    display: none;
    background: none;
    border: none;
    cursor: pointer;
    z-index: 1001;
}
.hamburger span {
    display: block;
    width: 25px;
    height: 3px;
    margin: 5px 0;
    background-color: var(--text-light);
    border-radius: 3px;
    transition: all 0.3s ease;
}

/* --- Buttons --- */
.btn {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    border-radius: 50px;
    font-weight: 600;
    text-align: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.btn-primary {
    background: linear-gradient(90deg, var(--primary-gold), #ffc107);
    color: var(--text-dark);
}
.btn-secondary {
    background-color: transparent;
    border: 2px solid var(--primary-gold);
    color: var(--primary-gold);
}
.btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 15px var(--border-glow);
}

/* --- Hero Section --- */
.hero-section {
    display: flex;
    gap: 2rem;
    padding: 4rem 0;
    align-items: flex-start;
}
.feature-banner {
    flex: 3;
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.feature-banner img {
    width: 100%;
    object-fit: cover;
}
.banner-content {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 2rem;
    background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
}
.banner-content h2 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.trending-list {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    background-color: rgba(42, 23, 90, 0.5);
    padding: 1.5rem;
    border-radius: 12px;
}
.trending-list h3 {
    margin-bottom: 0.5rem;
    border-bottom: 2px solid var(--border-glow);
    padding-bottom: 0.5rem;
}
.trending-item {
    display: flex;
    gap: 1rem;
    align-items: center;
}
.trending-item img {
    width: 60px;
    height: 90px;
    object-fit: cover;
    border-radius: 4px;
}
.trending-info h4 { font-size: 1rem; }
.trending-info p { font-size: 0.8rem; color: #ccc; }

/* --- Popular Slider --- */
.popular-slider-section {
    padding: 4rem 0;
    position: relative;
}
.slider-container {
    position: relative;
    overflow: hidden;
}
.slider-wrapper {
    display: flex;
    transition: transform 0.5s ease-in-out;
}
.novel-card {
    flex: 0 0 250px; /* Adjust width as needed */
    margin: 0 1rem;
}
.novel-card a {
    display: block;
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.novel-card a:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px var(--border-glow);
}
.novel-cover {
    height: 350px;
    width: 100%;
    object-fit: cover;
}
.card-info {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 1rem;
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    color: var(--text-light);
}
.card-info h3 { font-size: 1.2rem; }
.card-info p { font-size: 0.8rem; height: 40px; overflow: hidden; }
.card-stats {
    display: flex;
    gap: 1rem;
    font-size: 0.8rem;
    margin: 0.5rem 0;
}
.slider-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background-color: rgba(42, 23, 90, 0.7);
    border: none;
    color: var(--primary-gold);
    font-size: 2rem;
    cursor: pointer;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    z-index: 10;
}
.slider-btn.prev { left: 10px; }
.slider-btn.next { right: 10px; }

/* --- Novel Grid Section --- */
.novel-grid-section { padding: 4rem 0; }
.novel-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 2rem;
}
.novel-card-grid a {
    display: block;
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.novel-card-grid a:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px var(--border-glow);
}
.card-info-grid {
    padding: 1rem;
    background-color: var(--bg-midnight-blue);
}
.card-info-grid h3 { color: var(--text-light); }

.pagination {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 3rem;
}
.pagination a, .pagination span {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-glow);
    border-radius: 4px;
}
.pagination a.active {
    background-color: var(--primary-gold);
    color: var(--text-dark);
}

/* --- Novel Detail Page --- */
.novel-detail-page { padding: 4rem 0; }
.novel-info-section {
    display: flex;
    gap: 3rem;
}
.novel-cover-container { flex: 1; }
.novel-cover-container img { border-radius: 8px; }
.novel-details { flex: 2; }
.novel-title { font-size: 2.5rem; }
.novel-author { font-size: 1.2rem; color: #ccc; margin-bottom: 1rem; }
.novel-tags { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
.tag { background-color: var(--bg-midnight-blue); padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.8rem; }
.novel-stats { margin: 1.5rem 0; display: flex; gap: 1.5rem; }
.novel-actions { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
.action-btn { background: var(--bg-midnight-blue); border: 1px solid var(--border-glow); color: var(--text-light); padding: 0.7rem 1.2rem; border-radius: 8px; cursor: pointer; }
.action-btn.active { background: var(--primary-purple); box-shadow: 0 0 10px var(--primary-purple); }
.rating-widget { display: flex; align-items: center; gap: 0.5rem; }
.stars .star { font-size: 1.5rem; cursor: pointer; color: #ccc; transition: color 0.2s; }
.stars .star:hover, .stars .star.selected { color: var(--primary-gold); }

.novel-summary, .chapter-list { margin-top: 3rem; }
.novel-summary h2, .chapter-list h2 { margin-bottom: 1rem; border-bottom: 2px solid var(--border-glow); padding-bottom: 0.5rem; }

.chapter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
}
.chapter-btn {
    background-color: var(--bg-midnight-blue);
    color: var(--text-light);
    border: 1px solid var(--border-glow);
    padding: 1rem;
    border-radius: 8px;
    cursor: pointer;
    text-align: left;
    transition: background-color 0.3s;
}
.chapter-btn:hover, .chapter-btn.active { background-color: var(--primary-purple); }

.chapter-reader {
    margin-top: 3rem;
    background-color: rgba(0,0,0,0.2);
    padding: 2rem;
    border-radius: 12px;
    min-height: 200px;
}
#reader-content p { margin-bottom: 1rem; font-size: 1.1rem; }
#reader-content img { margin: 0 auto 1rem auto; max-width: 800px; border-radius: 4px; }
.hidden { display: none; }

/* --- Footer --- */
footer {
    text-align: center;
    padding: 2rem 0;
    margin-top: 4rem;
    background-color: var(--bg-dark-violet);
    border-top: 1px solid var(--border-glow);
}

/* --- Animations --- */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* --- Responsive Design --- */
@media (max-width: 992px) {
    .hero-section { flex-direction: column; }
    .novel-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
    .novel-info-section { flex-direction: column; text-align: center; }
    .novel-cover-container { max-width: 300px; margin: 0 auto; }
    .novel-tags, .novel-actions, .novel-stats { justify-content: center; }
}

@media (max-width: 768px) {
    .menu-container {
        position: fixed;
        top: 0;
        right: -100%;
        width: 70%;
        height: 100vh;
        background-color: var(--bg-dark-violet);
        transition: right 0.4s ease-in-out;
        padding-top: 80px;
        box-shadow: -5px 0 20px rgba(0,0,0,0.5);
    }
    .menu-container.active { right: 0; }
    .nav-links { flex-direction: column; align-items: center; gap: 2.5rem; }
    .hamburger { display: block; }

    .hamburger.active span:nth-child(1) { transform: translateY(8px) rotate(45deg); }
    .hamburger.active span:nth-child(2) { opacity: 0; }
    .hamburger.active span:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }

    .novel-card { flex: 0 0 200px; }
    .novel-cover { height: 300px; }
}

@media (max-width: 480px) {
    .section-title { font-size: 1.5rem; }
    .banner-content h2 { font-size: 1.8rem; }
    .novel-card { flex: 0 0 150px; }
    .novel-cover { height: 220px; }
    .card-info p { display: none; }
    .card-info .btn { display: none; }
}

document.addEventListener('DOMContentLoaded', () => {

    // --- Google Apps Script Configuration ---
    // IMPORTANT: Replace with your deployed Web App URL from Google Apps Script.
    const GAS_WEB_APP_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE';

    // --- General UI Elements ---
    const header = document.getElementById('main-header');
    const hamburgerMenu = document.getElementById('hamburger-menu');
    const menuContainer = document.querySelector('.menu-container');

    // --- Sticky Header ---
    const handleScroll = () => {
        if (window.scrollY > 50) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
    };
    window.addEventListener('scroll', handleScroll);

    // --- Hamburger Menu ---
    if (hamburgerMenu) {
        hamburgerMenu.addEventListener('click', () => {
            hamburgerMenu.classList.toggle('active');
            menuContainer.classList.toggle('active');
        });
    }

    // --- Lazy Loading Images ---
    const lazyImages = document.querySelectorAll('img.lazy');
    const lazyLoad = (target) => {
        const io = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src || img.src; // Fallback to src
                    img.classList.remove('lazy');
                    observer.disconnect();
                }
            });
        });
        io.observe(target);
    };
    lazyImages.forEach(lazyLoad);

    // --- Popular Novel Slider ---
    const slider = document.getElementById('popular-slider');
    if (slider) {
        const wrapper = slider.querySelector('.slider-wrapper');
        const prevBtn = slider.querySelector('.slider-btn.prev');
        const nextBtn = slider.querySelector('.slider-btn.next');
        const cards = slider.querySelectorAll('.novel-card');
        if (cards.length > 0) {
            let currentIndex = 0;
            const cardWidth = cards[0].offsetWidth + 2 * 16; // width + margin
            const itemsToShow = Math.floor(slider.offsetWidth / cardWidth);
            const totalSlides = Math.ceil(cards.length / itemsToShow);

            const updateSlider = () => {
                wrapper.style.transform = `translateX(-${currentIndex * cardWidth * itemsToShow}px)`;
            };

            nextBtn.addEventListener('click', () => {
                currentIndex = (currentIndex + 1) % totalSlides;
                updateSlider();
            });

            prevBtn.addEventListener('click', () => {
                currentIndex = (currentIndex - 1 + totalSlides) % totalSlides;
                updateSlider();
            });
            
            // Auto-rotate
            setInterval(() => {
                nextBtn.click();
            }, 5000);

            // Touch/Swipe support
            let touchStartX = 0;
            let touchEndX = 0;
            wrapper.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            });
            wrapper.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                if (touchEndX < touchStartX) nextBtn.click();
                if (touchEndX > touchStartX) prevBtn.click();
            });
        }
    }


    // --- Novel Detail Page Logic ---
    const novelDetailPage = document.querySelector('body[data-novel-id]');
    if (novelDetailPage) {
        const novelId = novelDetailPage.dataset.novelId;

        // Elements
        const viewCountEl = document.getElementById('view-count');
        const likeCountEl = document.getElementById('like-count');
        const bookmarkCountEl = document.getElementById('bookmark-count');
        const currentRatingEl = document.getElementById('current-rating');
        const likeBtn = document.getElementById('like-btn');
        const bookmarkBtn = document.getElementById('bookmark-btn');
        const ratingStars = document.getElementById('rating-stars');
        const chapterGrid = document.getElementById('chapter-grid');
        const readerContainer = document.getElementById('chapter-reader-container');
        const readerContent = document.getElementById('reader-content');
        const readerPlaceholder = readerContainer.querySelector('.reader-placeholder');


        // --- GAS API Communication ---
        const callGas = async (action, method = 'GET', data = null) => {
             if (GAS_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                console.warn("Google Apps Script URL is not set. Please update it in script.js.");
                // Provide mock data for UI testing
                return { success: true, data: { views: 1234, likes: 56, bookmarks: 78, rating: 4.5 } };
            }
            try {
                const url = `${GAS_WEB_APP_URL}?action=${action}&novelId=${novelId}`;
                const options = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                };
                if (method === 'POST' && data) {
                    options.body = JSON.stringify({ ...data, novelId, action });
                }
                const response = await fetch(method === 'GET' ? url : GAS_WEB_APP_URL, options);
                return await response.json();
            } catch (error) {
                console.error('Error communicating with GAS:', error);
                return { success: false, error: error.message };
            }
        };

        // --- Load Initial Data ---
        const loadNovelData = async () => {
            const result = await callGas('getData');
            if (result.success && result.data) {
                viewCountEl.textContent = result.data.views.toLocaleString();
                likeCountEl.textContent = result.data.likes.toLocaleString();
                bookmarkCountEl.textContent = result.data.bookmarks.toLocaleString();
                currentRatingEl.textContent = `(${result.data.rating.toFixed(1)})`;
            } else {
                 viewCountEl.textContent = 'N/A';
                 likeCountEl.textContent = 'N/A';
                 bookmarkCountEl.textContent = 'N/A';
                 currentRatingEl.textContent = 'N/A';
            }
        };

        // --- Increment View Count ---
        const incrementView = async () => {
            await callGas('incrementView', 'POST');
            // We reload all data to ensure consistency
            loadNovelData();
        };

        // --- Event Handlers for Actions ---
        likeBtn.addEventListener('click', async () => {
            likeBtn.classList.toggle('active');
            const action = likeBtn.classList.contains('active') ? 'like' : 'unlike';
            const result = await callGas(action, 'POST');
            if (result.success) loadNovelData();
        });

        bookmarkBtn.addEventListener('click', async () => {
            bookmarkBtn.classList.toggle('active');
            const action = bookmarkBtn.classList.contains('active') ? 'bookmark' : 'unbookmark';
            const result = await callGas(action, 'POST');
            if (result.success) loadNovelData();
        });
        
        ratingStars.addEventListener('click', async (e) => {
            if (e.target.classList.contains('star')) {
                const ratingValue = e.target.dataset.value;
                const result = await callGas('rate', 'POST', { rating: parseInt(ratingValue) });
                if (result.success) {
                    loadNovelData();
                    // Update star display instantly
                    updateStars(ratingValue);
                }
            }
        });
        
        const updateStars = (rating) => {
            const stars = ratingStars.querySelectorAll('.star');
            stars.forEach(star => {
                star.textContent = star.dataset.value <= rating ? '★' : '☆';
                star.classList.toggle('selected', star.dataset.value <= rating);
            });
        };

        // --- Chapter Reader Logic ---
        chapterGrid.addEventListener('click', (e) => {
            if (e.target.classList.contains('chapter-btn')) {
                // Remove active state from other buttons
                chapterGrid.querySelectorAll('.chapter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');

                const chapterType = e.target.dataset.chapterType;
                const chapterNum = e.target.dataset.chapter;
                loadChapterContent(chapterType, chapterNum);
            }
        });

        const loadChapterContent = (type, num) => {
            readerPlaceholder.classList.add('hidden');
            readerContent.classList.remove('hidden');
            readerContent.innerHTML = `<p class="loading">Loading Chapter ${num}...</p>`;

            // Simulate fetching content
            setTimeout(() => {
                let content = '';
                if (type === 'text') {
                    content = `
                        <h3>Chapter ${num}: The Story Begins</h3>
                        <p>This is the content for chapter ${num}. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus lacinia odio vitae vestibulum vestibulum. Cras venenatis euismod malesuada.</p>
                        <p>Curabitur sit amet quam id tellus gravida vulputate. Proin eget tortor risus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Mauris placerat eleifend leo.</p>
                        <p>Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo. Quisque sit amet est et sapien ullamcorper pharetra. Vestibulum erat wisi, condimentum sed, commodo vitae, ornare sit amet, wisi.</p>
                    `;
                } else if (type === 'manga') {
                    content = `
                        <h3>Chapter ${num}: The Void (Manga)</h3>
                        <p>Displaying pages for the manga chapter.</p>
                        <img src="https://placehold.co/800x1200/1b0f3a/fde047?text=Page+1" alt="Manga Page 1" class="lazy">
                        <img src="https://placehold.co/800x1200/1b0f3a/fde047?text=Page+2" alt="Manga Page 2" class="lazy">
                        <img src="https://placehold.co/800x1200/1b0f3a/fde047?text=Page+3" alt="Manga Page 3" class="lazy">
                    `;
                }
                readerContent.innerHTML = content;
                // Make sure newly added images are also lazy-loaded
                readerContent.querySelectorAll('img.lazy').forEach(lazyLoad);
                 // Scroll to the reader
                readerContainer.scrollIntoView({ behavior: 'smooth' });
            }, 500); // 0.5s delay to simulate network request
        };


        // Initial load for the page
        incrementView();
    }
});

